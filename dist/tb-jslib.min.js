var TheBall;!function(e){var t;!function(e){var t;!function(e){var t=function(){function e(){}return e}();e.StatusData=t;var n=function(){function e(){this.ChangeListeners=[]}return e}();e.TrackingExtension=n;var a=function(){function e(){}return e.GetRelativeUrl=function(e){return e.RelativeLocation},e.UpdateObject=function(e,t,n){e.UIExtension.ChangeListeners.forEach(function(n){return n(e,t)})},e}();e.TrackedObject=a;var i=function(){function e(){this.TrackedObjectStorage={},this.LastProcessedTick="",this.InitialTick="";var e=$.ajax({url:"../../TheBall.Interface/StatusSummary/default.json",cache:!0,async:!1});$.when(e).then(function(e){var t;t=e.ChangeItemTrackingList.length>0?e.ChangeItemTrackingList[0]:"T:",this.InitialTick=t})}return e.prototype.SetObjectInStorage=function(e){var t=this.TrackedObjectStorage[e.ID];this.TrackedObjectStorage[e.ID]=e,t&&(e.UIExtension=t.UIExtension),this.setInnerObjectsInStorage(e)},e.prototype.setInnerObjectsInStorage=function(e){var t=this;"object"==typeof e&&$.each(e,function(e,n){if(n){if(n.MasterETag){console.log("Added inner object: "+n.RelativeLocation);var a=t.TrackedObjectStorage[n.ID];a&&(n.UIExtension=a.UIExtension),t.TrackedObjectStorage[n.ID]=n}t.setInnerObjectsInStorage(n)}})},e.prototype.ProcessStatusData=function(e){for(var t,n,i=e.ChangeItemTrackingList,r=0;r<i.length;r++){var o=i[r];if("T"!=o.charAt(0)){n||(n=t);var s=o.substr(2),c=(o.substr(0,1),this.TrackedObjectStorage[s]);c&&c.UIExtension&&c.UIExtension.LastUpdatedTick?console.log("Checking for update basis: "+c.ID+" "+c.UIExtension.LastUpdatedTick+" vs "+t):console.log("Not tracked update for id: "+s),c&&c.UIExtension&&c.UIExtension.LastUpdatedTick<t&&(console.log("Updating..."),a.UpdateObject(c,t,this))}else if(t=o,t<=this.LastProcessedTick)break}n&&(console.log("Processed up to tick: "+n),this.LastProcessedTick=n)},e.prototype.PerformAsyncPoll=function(){var e=this;$.ajax({url:"../../TheBall.Interface/StatusSummary/default.json",cache:!0,success:function(t){e.ProcessStatusData(t)}})},e.prototype.ProcessFetchedData=function(e){if(e.RelativeLocation){var t=this.TrackedObjectStorage[e.ID];if(t){var n=t.UIExtension;this.TrackedObjectStorage[e.ID]=e,t=e,e.UIExtension=n}}},e.prototype.FetchAndProcessJSONData=function(e){$.ajax({url:e,cache:!0,success:this.ProcessFetchedData})},e}();e.DataConnectionManager=i}(t=e.UI||(e.UI={}))}(t=e.Interface||(e.Interface={}))}(TheBall||(TheBall={}));var TheBall;!function(e){var t;!function(t){var n;!function(t){var n=function(){function e(e,t,n){this.inputElement=e,this.file=t,this.content=n}return e.prototype.IsSet=function(){return!!this.inputElement.name},e.prototype.GetPropertyName=function(){var e=this.inputElement.name;return e},e.prototype.GetEmbeddedPropertyContent=function(){return this.file&&this.file.name&&this.content?this.file.name+":"+this.content:null},e}();t.BinaryFileItem=n;var a=function(){function t(t,n){this.getHiddenInput=function(e,t){var n=null!=t?t.toString():"",a=$('<input type="hidden">').attr("name",e).val(n);return a},t||(t=new e.Interface.UI.DataConnectionManager),n||(n=".oipfile"),this.DCM=t,this.BinaryFileSelectorBase=n;var a=$("body"),i="<form style='margin:0px;width:0px;height:0px;background-color: transparent;border: 0px none transparent;padding: 0px;overflow: hidden;visibility:hidden'  enctype='multipart/form-data' id='OperationManager_DynamicIFrameForm' method='post' target='OperationManager_IFrame'></form> ",r="<iframe style='margin:0px;width:0px;height:0px;background-color: transparent;border: 0px none transparent;padding: 0px;overflow: hidden;visibility: hidden' name='OperationManager_IFrame' src='about:blank'></iframe>";a.append(i),a.append(r),this.$submitForm=$("#OperationManager_DynamicIFrameForm"),"function"!=typeof String.prototype.startsWith&&(String.prototype.startsWith=function(e){return 0===this.lastIndexOf(e,0)})}return t.prototype.SaveIndependentObject=function(e,t,n,a,i,r,o){var s=this.$submitForm;s.empty();var c=e,p=t+":"+n;s.append(this.getHiddenInput("ContentSourceInfo",p)),s.append(this.getHiddenInput("NORELOAD",""));var l;for(var u in a){l=u.startsWith("File_")?u.replace("File_","File_"+c+"_"):u.startsWith("Object_")?u.replace("Object_","Object_"+c+"_"):u.startsWith("FileEmbedded_")?u.replace("FileEmbedded_","FileEmbedded_"+c+"_"):c+"_"+u,o&&(l=o(l));var d=this.getHiddenInput(l,a[u]);s.append(d)}r||(r=function(){});var f=r,h=function(e){i&&i(e)},m=this;$.ajax({type:"POST",data:s.serialize()}).done(function(e){m.AjaxPollingOperation(e,h,f)}).fail(f),s.empty()},t.prototype.AjaxPollingOperation=function(e,t,n){var a=0,i=e.OperationID,r="../../TheBall.Interface/InterfaceOperation/"+i+".json",o=function(e,t){$.ajax(r).done(function(i){if(i&&i.ErrorMessage){console.log("OP Error: "+a);var r={ErrorCode:i.ErrorCode,ErrorMessage:i.ErrorMessage};n(r)}else console.log("OP Retrying in 1 sec... total count: "+a),a++,setTimeout(function(){e(e,t)},1e3)}).fail(t)};o(o,t)},t.prototype.SaveObject=function(e,t,n){var a=this.DCM.TrackedObjectStorage[e];if(!a)throw"Object not found with ID: "+e;if(a.MasterETag!=t)throw"Object ETag mismatch on save: "+e;this.SaveIndependentObject(a.ID,a.RelativeLocation,a.MasterETag,n)},t.prototype.DeleteIndependentObject=function(e,t,n,a,i){var r=this.$submitForm;r.empty(),r.append(this.getHiddenInput("ObjectDomainName",e)),r.append(this.getHiddenInput("ObjectName",t)),r.append(this.getHiddenInput("ObjectID",n)),r.append(this.getHiddenInput("ExecuteOperation","DeleteSpecifiedInformationObject")),r.append(this.getHiddenInput("NORELOAD","")),i||(i=function(){});var o=i,s=function(e){a&&a(e)},c=this;$.ajax({type:"POST",data:r.serialize()}).done(function(e){c.AjaxPollingOperation(e,s,o)}).fail(o),r.empty()},t.prototype.DeleteObject=function(e){var t=this.DCM.TrackedObjectStorage[e];if(!t)throw"Object not found with ID: "+e;var e=(t.RelativeLocation+":"+t.MasterETag,t.ID),n=t.SemanticDomainName,a=t.Name;this.DeleteIndependentObject(n,a,e)},t.prototype.CreateObjectAjax=function(e,t,n,a,i){var r=this.$submitForm;r.empty(),r.append(this.getHiddenInput("ObjectDomainName",e)),r.append(this.getHiddenInput("ObjectName",t)),r.append(this.getHiddenInput("ExecuteOperation","CreateSpecifiedInformationObjectWithValues")),r.append(this.getHiddenInput("NORELOAD",""));for(var o in n){var s=this.getHiddenInput(o,n[o]);r.append(s)}i||(i=function(){});var c=i,p=function(e){a&&a(e)},l=this;$.ajax({type:"POST",data:r.serialize()}).done(function(e){l.AjaxPollingOperation(e,p,c)}).fail(c),r.empty()},t.prototype.ExecuteOperationWithForm=function(e,t,n,a){var i=this.$submitForm;i.empty(),i.append(this.getHiddenInput("ExecuteOperation",e));for(var r in t){var o=this.getHiddenInput(r,t[r]);i.append(o)}i.append(this.getHiddenInput("NORELOAD","")),a||(a=function(){});var s=a,c=function(e){n&&n(e)},p=this;$.ajax({type:"POST",data:i.serialize()}).done(function(e){p.AjaxPollingOperation(e,c,s)}).fail(s),i.empty()},t.prototype.ExecuteOperationWithAjax=function(e,t,n,a){var i=JSON.stringify(t);a||(a=function(){});var r=a,o=function(e){n&&n(e)},s=this;$.ajax({type:"POST",url:"?operation="+e,contentType:"application/json",data:i}).done(function(e){s.AjaxPollingOperation(e,o,r)}).fail(r)},t.prototype.setButtonMode=function(e,t){var n="add"==t?"Add Image":"Remove Image";e.attr("data-mode",t),e.html(n)},t.prototype.reset_field=function(e){e.wrap("<form>").parent("form").trigger("reset"),e.unwrap()},t.prototype.setImageValues=function(e,t,n){t.removeAttr("name"),e.attr("name",n)},t.prototype.clearImageValue=function(e,t,n){t.attr("name",n),e.removeAttr("name")},t.prototype.setSelectFileButtonEvents=function(e,t){e.off("click.oip").on("click.oip",function(){t.click()})},t.prototype.setRemoveFileButtonEvents=function(e,t,n,a){var i=this;e.off("click.oip").on("click.oip",function(){var e=t.attr("data-oipfile-propertyname");i.reset_field(t),i.setPreviewImageSrc(a,null),i.clearImageValue(t,n,e)})},t.prototype.setPreviewImageSrc=function(e,t){if(t)console.log("Existing src: "+e.attr("src")),console.log("Changing-to src: "+t),e.attr("src",t),console.log("New src: "+e.attr("src")),e.show();else{var n=e.attr("data-oipfile-noimageurl");n||e.hide(),e.attr("src",n)}},t.prototype.setFileInputEvents=function(e,t,n){var a=this,i=e.attr("data-oipfile-propertyname"),r="change.oip";e.off(r).on(r,function(){var r=this;if(r.files&&r.files[0]){var o=new FileReader;o.onload=function(r){a.setPreviewImageSrc(n,r.target.result),a.setImageValues(e,t,i)},o.readAsDataURL(r.files[0])}})},t.prototype.InitiateBinaryFileElementsAroundInput=function(e,t,n,a,i,r){var o=(this.BinaryFileSelectorBase,"data-"),s="oipfile-filegroupid",c="oipfile-objectid",p="oipfile-propertyname",l="oipfile-buttontype",u="select",d="remove",f="oipfile-noimageurl";if(0===e.length){if(e=$("input.oipfile-rootitem["+o+s+"='"+r+"']"),0===e.length)throw"Cannot find existing $fileInput for group: "+r}else e.addClass("oipfile-rootitem"),e.attr(o+s,r);e.addClass("oipfile"),e.hide(),e.width(0),e.height(0),e.attr(o+p,n),e.attr(o+c,t),e.removeAttr("name"),this.reset_field(e);var h="[data-"+s+"='"+r+"']",m="img.oipfile"+h,g=$(m);0===g.length&&(g=$("<img class='oipfile' />"),g.attr(o+s,r),i||(i=""),g.attr(o+f,i),g.insertBefore(e)),console.log("Trying to set preview url as: "+a),this.setPreviewImageSrc(g,a);var v="input.oipfile[type='hidden']"+h,I=$(v);0===I.length&&(I=$("<input class='oipfile' type='hidden'>"),I.attr(o+s,r),I.insertBefore(e)),I.removeAttr("name"),this.setFileInputEvents(e,I,g);var y=".oipfile"+h+"[data-"+l+"='"+u+"']",T=$(y);0===T.length&&(T=$("<a class='button small oipfile'>Select</a>"),T.attr(o+s,r),T.attr(o+l,u),T.insertAfter(e)),this.setSelectFileButtonEvents(T,e);var O=".oipfile"+h+"[data-"+l+"='"+d+"']",b=$(O);0===b.length&&(b=$("<a class='button small oipfile'>Remove</a>"),b.attr(o+s,r),b.attr(o+l,d),b.insertAfter(T)),this.setRemoveFileButtonEvents(b,e,I,g)},t.prototype.InitiateBinaryFileElements=function(e,t,n,a,i){var r=$("#"+e),o="data-",s="oipfile-filegroupid",c=r.attr(o+s);this.InitiateBinaryFileElementsAroundInput(r,t,n,a,i,c)},t.prototype.readFileFromInputAsync=function(e){if(e.files&&e.files[0]){var t=e.files[0];return this.readFileAsync(e,t)}var a=$.Deferred();return a.resolve(new n(e,null,null)),a.promise()},t.prototype.readFileAsync=function(e,t){var a=new FileReader,i=$.Deferred();return a.onload=function(a){i.resolve(new n(e,t,a.target.result))},a.onerror=function(){i.reject(this)},a.readAsDataURL(t),i.promise()},t.prototype.AppendBinaryFileValuesToData=function(e,t,n){this.PrepareBinaryFileContents(e,function(e){for(var a,i,r=0;r<e.length;r++){var o=e[r],s=o.GetPropertyName();o.IsSet()&&s&&(i=o.GetEmbeddedPropertyContent(),a="FileEmbedded_"+s,t[a]=i)}n()})},t.prototype.PrepareBinaryFileContents=function(e,t){var a=this,i=(this.BinaryFileSelectorBase,"input.oipfile[type='file'][data-oipfile-objectid='"+e+"' ]"),r=i+"[name]",o=i+":not([name])",s="input.oipfile[type='hidden']",c=s+"[name]",p=$(),l=$(o);l.each(function(e,t){var n=$(this).attr("data-oipfile-filegroupid"),a=c+"[data-oipfile-filegroupid='"+n+"']",i=$(a);p=p.add(i)});var u=$(r),d=u.map(function(e,t){var n=t;return a.readFileFromInputAsync(n)}),f=p,h=f.map(function(e,t){var a=t;return new n(a,null,null)}),m=d.add(h);$.when.apply($,m).then(function(){var e=arguments;t(e)})},t}();t.OperationManager=a}(n=t.UI||(t.UI={}))}(t=e.Interface||(e.Interface={}))}(TheBall||(TheBall={}));var OperationManager=TheBall.Interface.UI.OperationManager,$TB=new OperationManager(null,null),TheBall;!function(e){!function(t){!function(t){var n=function(){function e(e,t,n,a,i,r){this.templateName=e,this.jQuerySelector=t,this.dataSources=n,this.preRenderingDataProcessor=a,this.postRenderingDataProcessor=i,this.hiddenElementRendering=r}return e}();t.TemplateHook=n;var a=function(){function e(e,t,n){this.Timestamp=e,this.FetchUrl=t,this.FetchCallBack=n}return e.prototype.ExecuteAjaxToPromise=function(){return this.ajaxPromise||(this.ajaxPromise=this.ajaxPromise=$.ajax({url:this.FetchUrl,cache:!0,success:this.FetchCallBack})),this.ajaxPromise},e}();t.TimestampedFetch=a;var i=function(){function e(){this.UsedInTemplates=[]}return e.prototype.GetObjectContent=function(){return this.DCM.TrackedObjectStorage[this.ObjectID]},e.prototype.RefreshTemplates=function(e){this.TMM.RefreshNamedTemplates(e,this.UsedInTemplates)},e}();t.TemplateDataSource=i;var r=function(){function t(t){this.DataSourceFetchStorage={},this.TemplateHookStorage={},t||(t=new e.Interface.UI.DataConnectionManager),this.DCM=t}return t.prototype.CreateTimestampedFetchWithZeroTimestamp=function(e,t){var n=new a("",e,t);return n},t.prototype.CreateObjectUpdateFetchPromise=function(e,t){var n=this,i=new a(e,t.UIExtension.FetchedUrl,function(a){a.UIExtension=t.UIExtension,a.UIExtension.LastUpdatedTick=e,n.DCM.SetObjectInStorage(a)});return i},t.prototype.InitialObjectFetchCB=function(t,n){var a=this;if(t.ID){t.ID;t.UIExtension=new e.Interface.UI.TrackingExtension,t.UIExtension.FetchedUrl=n.RelativeUrl,t.UIExtension.ChangeListeners.push(function(e,t){n.FetchInfo.Timestamp!=t&&(n.FetchInfo=a.CreateObjectUpdateFetchPromise(t,e),n.RefreshTemplates(t))}),t.UIExtension.LastUpdatedTick=a.DCM.InitialTick,this.DCM.SetObjectInStorage(t)}n.ObjectID=t.ID},t.prototype.InitiateTemplateDataSource=function(e,t){var n=this.DataSourceFetchStorage[e],a=this;return n||(n=new i,n.DCM=a.DCM,n.TMM=a,n.RelativeUrl=e,this.DataSourceFetchStorage[e]=n,n.FetchInfo=this.CreateTimestampedFetchWithZeroTimestamp(e,function(e){a.InitialObjectFetchCB(e,n)})),n.UsedInTemplates.push(t),n},t.prototype.RegisterAndReplaceTemplate=function(e,t,n,a,i,r){this.TemplateHookStorage[e]&&(this.TemplateHookStorage[e]=null),this.RegisterTemplate(e,t,n,a,i,r)},t.prototype.RegisterTemplate=function(e,t,a,i,r,o){var s=this;if(this.TemplateHookStorage[e])throw"Template name already registered: "+e;this.TemplateHookStorage[e]=new n(e,t,a.map(function(t){return s.InitiateTemplateDataSource(t,e)}),i,r,o)},t.prototype.ActivateTemplate=function(e,t,n,a,i,r){this.RefreshTemplate("T:",e,t,n,a,i,r)},t.prototype.RefreshTemplate=function(e,t,n,a,i,r,o){var s,c=$(o),p=c.filter(":visible"),l=c.filter(":hidden");if(l.length>0){var u=l.not('[data-oiptimestamp="'+e+'"][data-oipvisible="false"]');u.length>0&&(r(n,u),u.each(function(){var t=$(this);t.attr("data-oiptimestamp",e),t.attr("data-oipvisible","false")}))}if(0!=p.length){var d=p.not('[data-oiptimestamp="'+e+'"][data-oipvisible="true"]');0!=d.length&&(d.each(function(){var t=$(this);t.attr("data-oiptimestamp",e),t.attr("data-oipvisible","true")}),console.log("Promise execution: "+t),s=n.map(function(e){return e.FetchInfo.ExecuteAjaxToPromise()}),$.when.apply($,s).then(function(){console.log("Root object fetch");var e=a(n);console.log("Rendering dust: "+t),dust.render(t,e,function(e,t){console.log("Done rendering"),console.log(t.substr(0,20)),d.each(function(){var e=$(this);e.html(t)}),i&&i(n,d)})}))}},t.prototype.ActivateNamedTemplates=function(e){for(var t=this,n=0;n<e.length;n++){var a=e[n],i=this.TemplateHookStorage[a];t.ActivateTemplate(i.templateName,i.dataSources,i.preRenderingDataProcessor,i.postRenderingDataProcessor,i.hiddenElementRendering,i.jQuerySelector)}},t.prototype.RefreshNamedTemplates=function(e,t){for(var n=this,a=0;a<t.length;a++){var i=t[a],r=this.TemplateHookStorage[i];n.RefreshTemplate(e,r.templateName,r.dataSources,r.preRenderingDataProcessor,r.postRenderingDataProcessor,r.hiddenElementRendering,r.jQuerySelector)}},t.prototype.ActivateAllTemplates=function(){var e=this;for(var t in this.TemplateHookStorage){var n=this.TemplateHookStorage[t];e.ActivateTemplate(n.templateName,n.dataSources,n.preRenderingDataProcessor,n.postRenderingDataProcessor,n.hiddenElementRendering,n.jQuerySelector)}},t.prototype.RefreshAllTemplateVisibility=function(){var e=this;for(var t in e.TemplateHookStorage){var n=e.TemplateHookStorage[t],a="";n.dataSources.forEach(function(e){a<e.FetchInfo.Timestamp&&(a=e.FetchInfo.Timestamp)}),e.RefreshTemplate(a,n.templateName,n.dataSources,n.preRenderingDataProcessor,n.postRenderingDataProcessor,n.hiddenElementRendering,n.jQuerySelector)}},t}();t.TemplateModuleManager=r}(t.UI||(t.UI={}));t.UI}(e.Interface||(e.Interface={}));e.Interface}(TheBall||(TheBall={}));var TheBall;!function(e){var t;!function(e){var t;!function(e){var t=function(){function e(e,t,n,a,i,r,o){this.isJSONUrl=e,this.urlKey=t,this.constructData=n,this.onUpdate=a,this.boundToElements=i,this.boundToObjects=r,this.dataSourceObjects=o,this.onUpdate=a||[],this.boundToElements=i||[],this.boundToObjects=r||[],this.dataSourceObjects=o||[]}return e}();e.ResourceLocatedObject=t;var n=function(){function e(){this.TrackedURLDictionary={}}return e.prototype.registerSourceUrls=function(e){var n=this;e.forEach(function(e){if(!n.TrackedURLDictionary[e]){var a=n.isJSONUrl(e);if(!a)throw"Local source URL needs to be defined before using as source";var i=new t(a,e,null);n.TrackedURLDictionary[e]=i}})},e.prototype.isJSONUrl=function(e){return-1!=e.indexOf("/")},e.prototype.getOrRegisterUrl=function(e){var n=this.TrackedURLDictionary[e];if(!n){var a=this.isJSONUrl(e);n=new t(a,e,null),this.TrackedURLDictionary[e]=n}return n},e.prototype.RegisterAndBindDataToElements=function(e,t,n,a){var i=this;a&&this.registerSourceUrls(a);var r=this.getOrRegisterUrl(t);a&&(r.dataSourceObjects=a.map(function(e){return i.TrackedURLDictionary[e]}))},e.prototype.RegisterDataURL=function(e,t,n){var a=this,i=a.getOrRegisterUrl(e);return i.constructData=t,n&&(a.registerSourceUrls(n),i.dataSourceObjects=n.map(function(e){return a.getOrRegisterUrl(e)})),i},e.prototype.UnregisterDataUrl=function(e){this.TrackedURLDictionary[e]&&delete this.TrackedURLDictionary[e]},e.prototype.GetData=function(e,t){var n=this.TrackedURLDictionary[e];if(!n)throw"Data URL needs to be registered before GetData: "+e;if(n.isJSONUrl)$.getJSON(e,function(e){t(e)});else{var a=this.getDataPromise(e);$.when(a).then(function(e){return t(e)})}},e.prototype.getDataPromise=function(e){var t=this,n=this.TrackedURLDictionary[e];if(!n)throw"Data URL needs to be registered before getDataPromise: "+e;var a;if(n.isJSONUrl)a=$.ajax({url:e});else{var i=n.dataSourceObjects.map(function(e){return t.getDataPromise(e.urlKey)});a=$.Deferred(),$.when.apply($,i).then(function(){var e=arguments,t=n.constructData(e);return a.resolve(t)})}return a},e}();e.UpdatingDataGetter=n}(t=e.UI||(e.UI={}))}(t=e.Interface||(e.Interface={}))}(TheBall||(TheBall={}));